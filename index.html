<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Weight Tracker</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#2563eb">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Weight">
  <link rel="apple-touch-icon" href="icon-192.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { background: #f0f4f8; }
    .card { background: white; border-radius: 0.75rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 1.5rem; }
    .progress-bar { transition: width 0.4s ease; }
    .table-scroll { max-height: 300px; overflow-y: auto; }
    .bmi-underweight { color: #3b82f6; }
    .bmi-normal { color: #22c55e; }
    .bmi-overweight { color: #f59e0b; }
    .bmi-obese { color: #ef4444; }
  </style>
</head>
<body class="min-h-screen p-4 md:p-8">

  <!-- Header -->
  <header class="max-w-5xl mx-auto mb-6">
    <h1 class="text-3xl font-bold text-gray-800">Weight Tracker</h1>
    <p class="text-gray-500 mt-1">Track your progress, reach your goals.</p>
  </header>

  <main class="max-w-5xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-6">

    <!-- Weight Entry Form -->
    <div class="card">
      <h2 class="text-lg font-semibold text-gray-700 mb-4">Log Weight</h2>
      <form id="weight-form" class="space-y-3">
        <div>
          <label class="block text-sm font-medium text-gray-600 mb-1" for="entry-date">Date</label>
          <input type="date" id="entry-date" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400" required>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-600 mb-1" for="entry-weight">Weight (lbs)</label>
          <input type="number" id="entry-weight" step="0.1" min="1" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="e.g. 175.5" required>
        </div>
        <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 rounded-lg transition">Add Entry</button>
      </form>
    </div>

    <!-- Goal Setting -->
    <div class="card">
      <h2 class="text-lg font-semibold text-gray-700 mb-4">Goal</h2>
      <div class="space-y-3">
        <div>
          <label class="block text-sm font-medium text-gray-600 mb-1" for="goal-weight">Target Weight (lbs)</label>
          <div class="flex gap-2">
            <input type="number" id="goal-weight" step="0.1" min="1" class="flex-1 border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="e.g. 160">
            <button id="set-goal-btn" class="bg-green-600 hover:bg-green-700 text-white font-medium px-4 py-2 rounded-lg transition">Set</button>
          </div>
        </div>
        <div id="goal-display" class="hidden">
          <div class="flex justify-between text-sm text-gray-600 mb-1">
            <span id="goal-start-label">Start: --</span>
            <span id="goal-target-label">Goal: --</span>
          </div>
          <div class="w-full bg-gray-200 rounded-full h-4 overflow-hidden">
            <div id="goal-progress" class="progress-bar bg-green-500 h-4 rounded-full" style="width:0%"></div>
          </div>
          <p id="goal-status" class="text-sm text-gray-500 mt-1"></p>
        </div>
      </div>
    </div>

    <!-- BMI Calculator -->
    <div class="card">
      <h2 class="text-lg font-semibold text-gray-700 mb-4">BMI Calculator</h2>
      <div class="space-y-3">
        <div>
          <label class="block text-sm font-medium text-gray-600 mb-1" for="height-inches">Height (inches)</label>
          <div class="flex gap-2">
            <input type="number" id="height-inches" step="0.1" min="1" class="flex-1 border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="e.g. 70">
            <button id="set-height-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-medium px-4 py-2 rounded-lg transition">Set</button>
          </div>
        </div>
        <div id="bmi-display" class="text-center py-3">
          <p class="text-sm text-gray-500">Enter height and log a weight to see BMI</p>
        </div>
      </div>
    </div>

    <!-- Statistics Panel -->
    <div class="card">
      <h2 class="text-lg font-semibold text-gray-700 mb-4">Statistics</h2>
      <div class="grid grid-cols-3 gap-3 text-center">
        <div>
          <p class="text-xs text-gray-500 uppercase">Daily</p>
          <p id="stat-daily" class="text-xl font-bold text-gray-700">--</p>
        </div>
        <div>
          <p class="text-xs text-gray-500 uppercase">7-Day</p>
          <p id="stat-7day" class="text-xl font-bold text-gray-700">--</p>
        </div>
        <div>
          <p class="text-xs text-gray-500 uppercase">30-Day</p>
          <p id="stat-30day" class="text-xl font-bold text-gray-700">--</p>
        </div>
      </div>
    </div>

    <!-- Line Chart -->
    <div class="card md:col-span-2">
      <h2 class="text-lg font-semibold text-gray-700 mb-4">Trend</h2>
      <canvas id="weight-chart"></canvas>
    </div>

    <!-- Data Table -->
    <div class="card md:col-span-2">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-lg font-semibold text-gray-700">Entries</h2>
        <button id="export-btn" class="bg-gray-700 hover:bg-gray-800 text-white text-sm font-medium px-4 py-2 rounded-lg transition">Export CSV</button>
      </div>
      <div class="table-scroll">
        <table class="w-full text-sm">
          <thead class="sticky top-0 bg-white">
            <tr class="border-b border-gray-200 text-left text-gray-500">
              <th class="py-2 pr-4">Date</th>
              <th class="py-2 pr-4">Weight (lbs)</th>
              <th class="py-2 pr-4">Change</th>
              <th class="py-2"></th>
            </tr>
          </thead>
          <tbody id="entries-table"></tbody>
        </table>
      </div>
      <p id="no-entries" class="text-gray-400 text-sm text-center py-4">No entries yet. Log your first weight above.</p>
      <div class="mt-4 border-t border-gray-100 pt-4">
        <button id="show-import-btn" onclick="document.getElementById('import-panel').classList.toggle('hidden'); this.textContent = document.getElementById('import-panel').classList.contains('hidden') ? 'Import Data...' : 'Hide Import'" class="text-sm text-blue-600 hover:text-blue-800">Import Data...</button>
        <div id="import-panel" class="hidden mt-3">
          <p class="text-sm text-gray-500 mb-3">Paste your notes below — one entry per line. Supports formats like "1/15 185.2", "Jan 16 184.8", "2025-01-17 185.0"</p>
          <textarea id="import-text" rows="5" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm font-mono focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="1/15 185.2&#10;1/16 184.8&#10;Jan 17 185.0"></textarea>
          <div class="flex items-center gap-3 mt-3">
            <button id="import-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-medium px-4 py-2 rounded-lg transition text-sm">Import</button>
            <span id="import-status" class="text-sm"></span>
          </div>
        </div>
      </div>
    </div>

  </main>

  <footer class="max-w-5xl mx-auto mt-8 mb-4 text-center text-xs text-gray-400">
    Data is stored locally in your browser.
  </footer>

<script>
  // ---- State ----
  const STORAGE_KEY = 'weightTrackerEntries';
  const GOAL_KEY = 'weightTrackerGoal';
  const HEIGHT_KEY = 'weightTrackerHeight';

  function loadEntries() {
    try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || []; }
    catch { return []; }
  }
  function saveEntries(entries) { localStorage.setItem(STORAGE_KEY, JSON.stringify(entries)); }

  function loadGoal() { return parseFloat(localStorage.getItem(GOAL_KEY)) || null; }
  function saveGoal(v) { localStorage.setItem(GOAL_KEY, v); }

  function loadHeight() { return parseFloat(localStorage.getItem(HEIGHT_KEY)) || null; }
  function saveHeight(v) { localStorage.setItem(HEIGHT_KEY, v); }

  // ---- Chart Setup ----
  const ctx = document.getElementById('weight-chart').getContext('2d');
  const chart = new Chart(ctx, {
    type: 'line',
    data: { labels: [], datasets: [{
      label: 'Weight (lbs)',
      data: [],
      borderColor: '#3b82f6',
      backgroundColor: 'rgba(59,130,246,0.1)',
      fill: true,
      tension: 0.3,
      pointRadius: 4,
      pointBackgroundColor: '#3b82f6'
    }] },
    options: {
      responsive: true,
      plugins: { legend: { display: false } },
      scales: {
        x: { grid: { display: false } },
        y: { beginAtZero: false }
      }
    }
  });

  // ---- Render Functions ----
  function renderAll() {
    const entries = loadEntries().sort((a, b) => a.date.localeCompare(b.date));
    renderChart(entries);
    renderTable(entries);
    renderStats(entries);
    renderGoal(entries);
    renderBMI(entries);
  }

  function renderChart(entries) {
    chart.data.labels = entries.map(e => e.date);
    chart.data.datasets[0].data = entries.map(e => e.weight);

    const goal = loadGoal();
    if (goal && entries.length > 0) {
      if (chart.data.datasets.length < 2) {
        chart.data.datasets.push({
          label: 'Goal',
          data: [],
          borderColor: '#22c55e',
          borderDash: [6, 4],
          pointRadius: 0,
          fill: false
        });
      }
      chart.data.datasets[1].data = entries.map(() => goal);
    } else if (chart.data.datasets.length > 1) {
      chart.data.datasets.splice(1, 1);
    }
    chart.update();
  }

  function renderTable(entries) {
    const tbody = document.getElementById('entries-table');
    const noMsg = document.getElementById('no-entries');
    if (entries.length === 0) { tbody.innerHTML = ''; noMsg.classList.remove('hidden'); return; }
    noMsg.classList.add('hidden');

    tbody.innerHTML = entries.slice().reverse().map((e, i, arr) => {
      const prevIdx = i + 1;
      let changeHTML = '--';
      if (prevIdx < arr.length) {
        const diff = (e.weight - arr[prevIdx].weight).toFixed(1);
        const sign = diff > 0 ? '+' : '';
        const color = diff > 0 ? 'text-red-500' : diff < 0 ? 'text-green-500' : 'text-gray-500';
        changeHTML = `<span class="${color}">${sign}${diff}</span>`;
      }
      return `<tr class="border-b border-gray-100">
        <td class="py-2 pr-4">${e.date}</td>
        <td class="py-2 pr-4">${e.weight}</td>
        <td class="py-2 pr-4">${changeHTML}</td>
        <td class="py-2 text-right"><button onclick="deleteEntry('${e.date}')" class="text-red-400 hover:text-red-600 text-xs">Delete</button></td>
      </tr>`;
    }).join('');
  }

  function renderStats(entries) {
    const daily = document.getElementById('stat-daily');
    const week = document.getElementById('stat-7day');
    const month = document.getElementById('stat-30day');

    if (entries.length < 2) { daily.textContent = '--'; week.textContent = '--'; month.textContent = '--'; return; }

    const latest = entries[entries.length - 1];
    const prev = entries[entries.length - 2];
    setStatEl(daily, latest.weight - prev.weight);

    const now = new Date(latest.date);
    const d7 = entries.filter(e => (now - new Date(e.date)) / 86400000 <= 7);
    if (d7.length >= 2) setStatEl(week, d7[d7.length - 1].weight - d7[0].weight);
    else week.textContent = '--';

    const d30 = entries.filter(e => (now - new Date(e.date)) / 86400000 <= 30);
    if (d30.length >= 2) setStatEl(month, d30[d30.length - 1].weight - d30[0].weight);
    else month.textContent = '--';
  }

  function setStatEl(el, diff) {
    const v = diff.toFixed(1);
    const sign = v > 0 ? '+' : '';
    el.textContent = `${sign}${v}`;
    el.className = 'text-xl font-bold ' + (v > 0 ? 'text-red-500' : v < 0 ? 'text-green-500' : 'text-gray-700');
  }

  function renderGoal(entries) {
    const goal = loadGoal();
    const display = document.getElementById('goal-display');
    if (!goal || entries.length === 0) { display.classList.add('hidden'); return; }
    display.classList.remove('hidden');

    const start = entries[0].weight;
    const current = entries[entries.length - 1].weight;
    document.getElementById('goal-target-label').textContent = `Goal: ${goal} lbs`;
    document.getElementById('goal-start-label').textContent = `Start: ${start} lbs`;

    const totalDiff = start - goal;
    const progress = totalDiff === 0 ? 100 : Math.min(100, Math.max(0, ((start - current) / totalDiff) * 100));
    document.getElementById('goal-progress').style.width = progress.toFixed(1) + '%';

    const remaining = (current - goal).toFixed(1);
    document.getElementById('goal-status').textContent = remaining <= 0
      ? 'Goal reached!'
      : `${remaining} lbs to go (${progress.toFixed(0)}% there)`;
  }

  function renderBMI(entries) {
    const height = loadHeight();
    const display = document.getElementById('bmi-display');
    if (!height || entries.length === 0) {
      display.innerHTML = '<p class="text-sm text-gray-500">Enter height and log a weight to see BMI</p>';
      return;
    }
    const weight = entries[entries.length - 1].weight;
    const bmi = ((weight / (height * height)) * 703).toFixed(1);
    let category, cls;
    if (bmi < 18.5) { category = 'Underweight'; cls = 'bmi-underweight'; }
    else if (bmi < 25) { category = 'Normal'; cls = 'bmi-normal'; }
    else if (bmi < 30) { category = 'Overweight'; cls = 'bmi-overweight'; }
    else { category = 'Obese'; cls = 'bmi-obese'; }

    display.innerHTML = `<p class="text-3xl font-bold ${cls}">${bmi}</p><p class="text-sm ${cls} font-medium">${category}</p>`;
  }

  // ---- Actions ----
  document.getElementById('weight-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const date = document.getElementById('entry-date').value;
    const weight = parseFloat(document.getElementById('entry-weight').value);
    if (!date || isNaN(weight)) return;

    const entries = loadEntries();
    const existing = entries.findIndex(e => e.date === date);
    if (existing !== -1) entries[existing].weight = weight;
    else entries.push({ date, weight });
    saveEntries(entries);
    document.getElementById('entry-weight').value = '';
    renderAll();
  });

  document.getElementById('set-goal-btn').addEventListener('click', function() {
    const v = parseFloat(document.getElementById('goal-weight').value);
    if (!isNaN(v) && v > 0) { saveGoal(v); renderAll(); }
  });

  document.getElementById('set-height-btn').addEventListener('click', function() {
    const v = parseFloat(document.getElementById('height-inches').value);
    if (!isNaN(v) && v > 0) { saveHeight(v); renderAll(); }
  });

  function deleteEntry(date) {
    const entries = loadEntries().filter(e => e.date !== date);
    saveEntries(entries);
    renderAll();
  }

  // ---- Import ----
  const MONTHS = {jan:0,feb:1,mar:2,apr:3,may:4,jun:5,jul:6,aug:7,sep:8,oct:9,nov:10,dec:11};

  function parseDate(str) {
    // ISO: 2025-01-15
    let m = str.match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/);
    if (m) return new Date(+m[1], +m[2]-1, +m[3]);
    // MM/DD/YYYY or MM/DD/YY
    m = str.match(/^(\d{1,2})\/(\d{1,2})(?:\/(\d{2,4}))?$/);
    if (m) {
      let y = m[3] ? (+m[3] < 100 ? 2000 + +m[3] : +m[3]) : new Date().getFullYear();
      return new Date(y, +m[1]-1, +m[2]);
    }
    // Mon DD YYYY or Mon DD
    m = str.match(/^([a-z]+)\s+(\d{1,2})(?:[\s,]+(\d{2,4}))?$/i);
    if (m && MONTHS[m[1].slice(0,3).toLowerCase()] !== undefined) {
      let y = m[3] ? (+m[3] < 100 ? 2000 + +m[3] : +m[3]) : new Date().getFullYear();
      return new Date(y, MONTHS[m[1].slice(0,3).toLowerCase()], +m[2]);
    }
    return null;
  }

  function parseLine(line) {
    line = line.trim();
    if (!line) return null;
    // Find the weight: last number in the line (possibly decimal)
    const nums = [...line.matchAll(/[\d]+\.?\d*/g)];
    if (nums.length === 0) return null;
    const weight = parseFloat(nums[nums.length - 1][0]);
    if (isNaN(weight) || weight < 50 || weight > 999) return null;
    // Everything before the weight is the date
    const weightStart = nums[nums.length - 1].index;
    const datePart = line.slice(0, weightStart).replace(/[:\-–—]+$/, '').trim();
    if (!datePart) return null;
    const date = parseDate(datePart);
    if (!date || isNaN(date.getTime())) return null;
    const iso = date.toISOString().slice(0, 10);
    return { date: iso, weight };
  }

  document.getElementById('import-btn').addEventListener('click', function() {
    const text = document.getElementById('import-text').value;
    const lines = text.split('\n');
    const entries = loadEntries();
    let added = 0, skipped = 0;
    for (const line of lines) {
      const parsed = parseLine(line);
      if (!parsed) { if (line.trim()) skipped++; continue; }
      const existing = entries.findIndex(e => e.date === parsed.date);
      if (existing !== -1) entries[existing].weight = parsed.weight;
      else entries.push(parsed);
      added++;
    }
    saveEntries(entries);
    const status = document.getElementById('import-status');
    status.textContent = `Imported ${added} entries` + (skipped ? `, ${skipped} lines skipped` : '');
    status.className = 'text-sm ' + (added > 0 ? 'text-green-600' : 'text-red-500');
    if (added > 0) { document.getElementById('import-text').value = ''; renderAll(); }
  });

  // ---- CSV Export ----
  document.getElementById('export-btn').addEventListener('click', function() {
    const entries = loadEntries().sort((a, b) => a.date.localeCompare(b.date));
    if (entries.length === 0) return;
    const csv = 'Date,Weight (lbs)\n' + entries.map(e => `${e.date},${e.weight}`).join('\n');
    const blob = new Blob([csv], { type: 'text/csv' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'weight-data.csv';
    a.click();
    URL.revokeObjectURL(a.href);
  });

  // ---- Init ----
  document.getElementById('entry-date').valueAsDate = new Date();
  const savedGoal = loadGoal();
  if (savedGoal) document.getElementById('goal-weight').value = savedGoal;
  const savedHeight = loadHeight();
  if (savedHeight) document.getElementById('height-inches').value = savedHeight;
  renderAll();

  // ---- Service Worker ----
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js');
  }
</script>
</body>
</html>
